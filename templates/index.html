<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Dynamic Parts Table</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
	<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet"> <!-- needed for current modal -->

	<style>
		* {
			margin: 0px;
			padding: 0px;
			box-sizing: border-box;
			font-family: sans-serif;

		}

		nav {
			width: 100%;
			height: 75px;
			background-color: rgb(26, 107, 30, .9);
			color: black;
			display: flex;
			justify-content: space-between;
			align-items: center;
			padding: 0px 50px;
			top: 0;
		}

		.search form {
			background-color: white;
			/* set background color for the search bar */
			padding: 2px;
			border: 1px solid black;
			border-radius: 30px;
			/* adjust border-radius to make the search bar more elongated */
			margin-bottom: 20px;
			margin-top: 20px;
			margin-left: auto;
			width: 300px;
			/* set width for demonstration */
			display: flex;
			/* align input and button horizontally */
			align-items: center;
			/* center items vertically */
		}

		.search input {
			flex: 1;
			/* take up remaining space */
			padding: 3px 8px;
			border: none;
			outline: none;
			font-size: 14px;
			border-radius: 30px;
		}

		.search input:hover {
			border: 1px solid #7babe2;
		}

		.search button {
			background-color: black;
			color: white;
			border: none;
			outline: none;
			padding: 3px 10px;
			border-radius: 30px;
			cursor: pointer;
		}

		.adminLogin button {
			color: black;
			font-size: 14px;
			border: none;
			outline: black;
			margin-left: auto;
			padding: 3px 10px;
			border-radius: 30px;
			cursor: pointer;
		}
		
		#btn-group-inout {
			display: block;
		}
		
		#btn-group-inout .btn {
			width: 50%;
			padding: 10px 0px;
			margin: 10px 0px;
			box-sizing: border-box;
			border: 1px solid black;
			font-size: 20px;
			float: left;
		}
		
		.btn-primary {
			background-color: rgb(26, 107, 30); /* green */
		}
		.btn-secondary {
			background-color: rgb(214, 214, 214); /* light grey*/
			color: rgb(0,0,0);
		}
		.btn-check:checked + .btn {
			background-color: rgb(26, 107, 30);
			color: rgb(255,255,255)
		}

		.btn-group form {
		/*	background-color: white;*/
		}

		.btn-submit {
			background-color: white;
			color: black;
			border: 1px solid black;
			width: 100%;
		}

		#parts-buttons {
			height: 100%;
			margin: 20px 0px;
		}
		#parts-buttons .btn {
			background-color: rgb(214, 214, 214);
			color: black;
			border: 1px solid black;
		}

		/* TOPBAR AND LOGO */
		.logo {
			font-weight: bold;
			width: 100px;
			height: 50px;
			margin-bottom: 0px;
			margin-right: 0px;
			float: left;
		}

		/* TEXT INPUT REQUEST AREA */
		#textarea-request {
			margin: 30px 0px 0px;
		}

		/* TABLE */
		.table-striped #partsTableBody tr:nth-of-type(2n+1) {
			background-color: rgb(223, 223, 185);
		}

		.table td,
		.table th {
			padding: .25rem;
			vertical-align: top;
			border-top: 1px solid #dee2e6;
		}

		.table .sortable-column {
			cursor: pointer;
		}

		/* MODAL */
		.background-modal {
			display: none;
			position: fixed;
			z-index: 1;
			left: 0;
			top: 0;
			width: 100%;
			height: 100%;
			overflow: auto;
			background-color: rgba(0, 0, 0, 0.4);
		  }
		  .modal-form {
			background-color: #fefefe;
			margin: 5% auto;
			padding: 20px;
			border: 1px solid #888;
			width: auto;
			max-width: 1000px;
		  }
		  .modal-header, .modal-footer {
			display: flex;
			justify-content: space-between;
			align-items: center;
			padding-bottom: 10px;
		  }
		  .modal-header {
			border-bottom: 1px solid #e5e5e5;
		  }
		  .modal-footer {
			border-top: 1px solid #e5e5e5;
			justify-content: flex-start;
		  }
		  .modal-content {
			display: flex;
			flex-wrap: wrap;
			align-items: center;
			justify-content: center;
			margin-bottom: 20px;
		  }
		  .form-control {
			margin: 5px;
			flex-grow: 1;
			min-width: 120px; 
		  }
		  .close {
			cursor: pointer;
			font-size: 1.5rem;
		  }
		  .btn-success {
			margin-top: 20px; 
		  }

	</style>
</head>

<body>
	<nav>
		<div class="logo">E-WASTE ENTERPRISES</div>
		<div class="adminLogin">
			<button type="button">Admin Login</button>
		</div>
	</nav>

	<div class="container-fluid">
		<div class="row">
			<div id="left-sidebar-check-inout" class="col-sm-3">
				<textarea id="textarea-request" class="form-control text-area-custom" rows="5"></textarea>
				
				<div id="btn-group-inout" class="btn-group" role="group" aria-label="Basic radio toggle button group">
					<input type="radio" class="btn-check" name="btnradio" id="btnradio1" autocomplete="off">
					<label class="btn btn-secondary" for="btnradio1">IN</label>

					<input type="radio" class="btn-check" name="btnradio" id="btnradio2" autocomplete="off">
					<label class="btn btn-secondary" for="btnradio2">OUT</label>
				</div>
				
				<button type="button" class="btn btn-primary btn-lg btn-submit" id="btn-submit-request">Submit</button>
			</div>
			<div id="parts-buttons-search-table" class="col-sm-9">
				<div class="row">
					<div id="parts-buttons" class="col-sm-9">
						<button id="showModalBtn" type="button" class="btn">Add Part</button>
						<button id="rmvPartBtn" type="button" class="btn">Remove Part</button>
						<button id="btnDemoCheckin" type="button" class="btn">Check-in Demo</button>
						<button id="btnDemoCheckinNotSeenBefore" type="button" class="btn">Check-In Demo Not Seen b4</button>
						<button id="btnDemoCheckinMismatch" type="button" class="btn">Check-in Demo Mismatch SN and Specs</button>
						<button id="btnResetLogTables" type="button" class="btn">Reset Log Tables</button>
					</div>
					<div class="search col-sm-3">
						<form>
							<input type="text" placeholder="Search">
							<button type="submit">Go</button>
						</form>
					</div>
				</div>
				<table id="partsTable" class="table table-striped">
					<thead>
						<tr>
							<th class="sortable-column">Type</th>
							<th class="sortable-column">Capacity</th>
							<th class="sortable-column">Size</th>
							<th class="sortable-column">Speed</th>
							<th class="sortable-column">Brand</th>
							<th class="sortable-column">Model</th>
							<th class="sortable-column">Location</th>
							<th class="sortable-column">Serial Number</th>
						</tr>
					</thead>
					<tbody id="partsTableBody">
						<!-- Table data will be loaded here via AJAX -->
					</tbody>
				</table>
			</div>
		</div>
	</div>

	<div id="Modal" class="background-modal">
		<div class="modal-form">
		  <div class="modal-header">
			<h3 id="modalTitle">Title</h3>
			<button type="button" class="close" id="closeModalBtn">&times;</button>
		  </div>
		  <div class="modal-body">
			<p id="modalContent"></p>
		  </div>
		</div>
	  </div>

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy" crossorigin="anonymous"></script>

	<script>
		$(document).ready(function () {
			// a commonly used function to
			// show content of JSON object
			fetchAndDisplayParts();

			/* ====== EVENT LISTENERS ===== */
			// Sort column
			$('.sortable-column').click(function () {
				var column = $(this).text().trim();  // Get the column name
				handleSort(column);  // Call handleSort function with the column name
			});

			$('#showModalBtn').click(function () {
				$('#addPartModal').show();
			});

			$('#closeModalBtn').click(function () {
				$('#addPartModal').hide();
			});
			
			$('#btn-submit-request').click(function() {
				var parsedData = parseTextInput();
				console.log(parsedData);
			});
			
			$('#btnDemoCheckin').click(function() {
				var demoPart = {
					"tid": "TI000000-00000001",
					"unit_sn": "123456",
					"parts": [{"capacity": "1 TB","type": "SSD"}],
					"size": "Laptop",
					"serial_numbers": ["00000022"]
				}
				checkInPart(demoPart);
			});
			$('#btnDemoCheckinNotSeenBefore').click(function() {
				var demoPart = {
					"tid": "TI000000-00000001",
					"unit_sn": "123456",
					"parts": [{"capacity": "99 TB","type": "SSD"}],
					"size": "Laptop",
					"serial_numbers": ["0000011"]
				}
				checkInPart(demoPart);
			});
			$('#btnDemoCheckinMismatch').click(function() {
				var demoPart = {
					"tid": "TI000000-00000001",
					"unit_sn": "123456",
					"parts": [{"capacity": "99 TB","type": "SSD"}],
					"size": "Laptop",
					"serial_numbers": ["0000010"]
				}
				checkInPart(demoPart);
			});
			$('#btnResetLogTables').click(function() {
				resetLogTables();
			});
			
			// Add part
			$('#add_btn').click(function () {
				const partData = {
					Type: $('#type').val(),
					Capacity: $('#capacity').val(),
					Size: $('#size').val(),
					Speed: $('#speed').val(),
					Brand: $('#brand').val(),
					Model: $('#model').val(),
					Location: $('#location').val(),
					Part_sn: $('#snumber').val()
				};
				handleAddPart(partData);
			});

			/* ====== FUNCTIONS ===== */
			function fetchAndDisplayParts() {
				$.ajax({
					url: '/get_parts',
					type: 'POST',
					dataType: 'json',
					success: function (data) {
						var tableBody = $('#partsTableBody');
						console.log("GETS PARTS HERE 1")
						tableBody.empty(); // Clear existing rows
						$.each(data, function (index, part) {
							tableBody.append('<tr>' +
								'<td>' + part.Type + '</td>' +
								'<td>' + part.Capacity + '</td>' +
								'<td>' + part.Size + '</td>' +
								'<td>' + part.Speed + '</td>' +
								'<td>' + part.Brand + '</td>' +
								'<td>' + part.Model + '</td>' +
								'<td>' + part.Location + '</td>' +
								'<td>' + part.Part_sn + '</td>' +
								'</tr>');
						});
					},
					error: function (xhr, status, error) {
						console.error("Error fetching parts data: " + error);
					}
				});
			} // end fetchAndDisplayParts
			
			// Modal
			function showModal(dataObject, htmlContent) {
				// Set the content of the modal
				$('#modalContent').html(htmlContent);

				// Set the title of the modal if a title is provided in dataObject
				if (dataObject && dataObject.title) {
					$('#modalTitle').text(dataObject.title);
				} else {
					// Default title if none provided
					$('#modalTitle').text('Details');
				}

				// Additional data handling could go here
				if (dataObject) {
					console.log("Additional data:", dataObject);
				}

				// Display the modal
				$('#Modal').css('display', 'block');

				// Setup close button to hide the modal
				$('#closeModalBtn').click(function() {
					$('#Modal').css('display', 'none');
				});

				// Handle background clicks to also close the modal
				$(window).click(function(event) {
					if ($(event.target).is('#Modal')) {
						$('#Modal').css('display', 'none');
					}
				});
			} // end Modal


			function handleSort(column) {
				// Make an AJAX request to the server to retrieve sorted data
				$.ajax({
					url: '/sort_parts',  // URL for sorting route in app.py
					method: 'POST',
					data: { column: column },  // Send the column to sort by
					success: function (response) {
						// Replace the table body with sorted data
						$('#partsTableBody').html('');
						response.forEach(function (part) {
							$('#partsTableBody').append(`<tr>
							<td>${part.Type}</td>
							<td>${part.Capacity}</td>
							<td>${part.Size}</td>
							<td>${part.Speed}</td>
							<td>${part.Brand}</td>
							<td>${part.Model}</td>
							<td>${part.Location}</td>
							<td>${part.Part_sn}</td>
						</tr>`);
							// print("Sorted by " + column + " column.");
						});
					},
					error: function (xhr, status, error) {
						console.error("Error sorting parts: " + error);
					}
				}); // end handleSort
			}

			//how add part works=> clicking add button (showModalBtn) opens the modal, which then prompts user input, clicking 
			//submit sends data to server utilizing current add and handleadd functions
			function handleAddPart(partData) {
				$.ajax({
					url: '/add_part',
					type: 'POST',
					contentType: 'application/json',
					dataType: 'json',
					data: JSON.stringify(partData),
					success: function (response) {
						console.log("ADD PARTS HERE 1")
						if (response.status === 'success') {
							$('#Modal').hide(); // hide modal
							fetchAndDisplayParts(); //refresh page with new data immediately
							$('#addPartForm')[0].reset(); //resets form	
						} else {
							alert("Failed to add the part." + response.message);
						}
					},
					error: function (xhr, status, error) {
						console.error("Error adding part: " + error);
						alert("Error adding part. Ensure all boxes are filled. " + error);
					}
				});
			} // end handleAddPart
		
			function parseTextInput() {
				var textContent = document.getElementById('textarea-request').value;
				var lines = textContent.trim().split('\n');
				var dataObject = {
					tid: null,
					unit_sn: null,
					parts: [],
					size: null,
					serial_numbers: []
				};

				if (lines.length < 4) { // Minimum number of lines for valid input
					console.error("Error: Insufficient input data.");
					return null;
				}

				// Parse TID
				dataObject.tid = lines[0].trim();
				if (!dataObject.tid.startsWith("TI") && !dataObject.tid.startsWith("TZZ")) {
					console.error("Error: Invalid TID format.");
					return null;
				}

				// Parse Unit_sn
				dataObject.unit_sn = lines[1].trim();
				if (!dataObject.unit_sn) {
					console.error("Error: Missing unit_sn.");
					return null;
				}

				// Parse parts and serial numbers
				var i = 2;
				while (lines[i] && !["Laptop", "Desktop", "Server"].includes(lines[i].trim())) {
					var details = lines[i].trim().split(' ');
					var part = {};

					if (details[0].match(/\d+(GB|TB)$/)) { // Drive
						part = {
							capacity: details[0],
							type: details.slice(1).join(' ')
						};
					} else { // RAM
						var capacityIndex = details.findIndex(detail => detail.match(/\d+(GB|MB)$/));
						part = {
							type: details.slice(0, capacityIndex).join(' '),
							capacity: details[capacityIndex]
						};
					}
					dataObject.parts.push(part);
					i++;
				}

				// Parse Size
				dataObject.size = lines[i].trim();
				i++;

				// Parse Serial Numbers
				while (i < lines.length) {
					dataObject.serial_numbers.push(lines[i].trim());
					i++;
				}

				if (dataObject.parts.length !== dataObject.serial_numbers.length) {
					console.error("Error: The number of parts does not match the number of serial numbers.");
                    alert('Error: The number of parts does not match the number of serial numbers.');
					return null;
				}

				return dataObject;
			} // end parseTextInput
			
			
			function checkInPart(dataObject) {
				// Assume dataObject has already been parsed and structured
				dataObject.parts.forEach((part, index) => {
					const partSn = dataObject.serial_numbers[index];  // Get the serial number for the current part

					// Prepare the data to be sent to the server including Type and Capacity
					const partData = {
						Part_sn: partSn,
						Type: part.type,
						Capacity: part.capacity,
						Size: dataObject.size,
						Speed: dataObject.Speed,
						Brand: dataObject.Brand,
						Model: dataObject.Model,
					};

					$.ajax({
						url: '/check_part_in_inventory',  // Server-side script to check the inventory
						type: 'POST',
						contentType: 'application/json',
						data: JSON.stringify(partData),
						success: function(response) {
							if (response.exists) {
								// If part exists and matches type and capacity, update its status to 'in'
								$.ajax({
									url: '/update_part_status',
									type: 'POST',
									contentType: 'application/json',
									data: JSON.stringify({
										Part_sn: partSn,
										TID: dataObject.tid,
										Unit_sn: dataObject.unit_sn,
										Part_status: 'in'
									}),
									success: function(updateResponse) {
											fetchAndDisplayParts();
									},
									error: function(err) {
										console.error("Error updating part status: ", err);
									}
								});
							} else {
								// If part does not exist or does not match, show modal to add part
								console.log(response.message); // Log the message from the server
								// Check for specific mismatch error
								if(response.error == 'mismatch') {
									const expectedDetails = response.expected;
									const actualDetails = response.actual;
									const content = `
										<p><strong>Expected: </strong>${expectedDetails.Capacity} ${expectedDetails.Type}</p>
										<p><strong>Found: </strong>${actualDetails.Capacity} ${actualDetails.Type}</p>
										
									`;
									showModal({ title: 'Check-in Error: ' + response.message }, content);
								}
								else if (response.error == 'checked-in'){
									console.log("Error: " + response.message); // Handle other errors
									const content = `
										<p><strong>That part is already checked-in.<strong></p>
										<p>Serial number: ${partSn}</p>
										<table width="100%" border="1">
										<tbody>
										<tr>
										  <th scope="col">&nbsp;Type</th>
										  <th scope="col">Capacity&nbsp;</th>
										  <th scope="col">Size&nbsp;</th>
										  <th scope="col">Speed&nbsp;</th>
										  <th scope="col">Brand&nbsp;</th>
										  <th scope="col">Model&nbsp;</th>
										  <th scope="col">Location&nbsp;</th>
										</tr>
										<tr>
											<td>${partData.Type}</td>
											<td>${partData.Capacity}</td>
											<td>${partData.Size}</td>
											<td>${partData.Speed}</td>
											<td>${partData.Brand}</td>
											<td>${partData.Model}</td>
											<td>${partData.Location}</td>
										</tr>
										</tbody>
										</table>
									`;
									showModal({ title: 'Check-in Error: ' + response.message }, content);
								}
							}
						},
						error: function(err) {
							console.error("Error checking part in inventory: ", err);
                            alert('Error checking part in inventory: ' + error);
						}
					});
				});
			} // end checkinPart
			
			function resetLogTables(){
                $.ajax({
                    url: '/reset_log_tables',  // URL of the Flask endpoint
                    type: 'POST',  // Method type, as defined in your Flask route
                    contentType: 'application/json',  // Data type expected to send (if you are sending data to the server)
                    success: function(response) {
                        // This function is called if the request succeeds.
                        console.log('Response:', response);
                        alert('Database has been reset successfully.');
						fetchAndDisplayParts();
                    },
                    error: function(xhr, status, error) {
                        // This function is called if the request fails.
                        console.error('Error resetting database:', error);
                        alert('Failed to reset database: ' + error);
                    }
                });
			} // end resetLogTables
			
		});
		
	</script>

</body>
</html>
